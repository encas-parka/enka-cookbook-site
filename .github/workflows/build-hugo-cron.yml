name: Build Hugo (Cron si modifications dans /content)

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  contents: read  # On n'a plus besoin d'Ã©crire dans le repo

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          ref: enka-next
          fetch-depth: 0
      
      # Restaurer le SHA depuis le cache
      - name: Restaurer le dernier SHA depuis le cache
        id: cache-sha
        uses: actions/cache/restore@v4
        with:
          path: last-sha.txt
          key: last-successful-build-sha-${{ github.ref }}
      
      - name: DÃ©terminer le SHA de rÃ©fÃ©rence
        id: reference-sha
        run: |
          if [ -f "last-sha.txt" ]; then
            LAST_SHA=$(cat last-sha.txt)
            if git rev-parse "$LAST_SHA" >/dev/null 2>&1; then
              echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
              echo "ğŸ“Œ Utilisation du SHA en cache : $LAST_SHA"
            else
              # PremiÃ¨re exÃ©cution ou cache invalide
              LAST_SHA=$(git rev-parse HEAD~1)
              echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
              echo "ğŸ†• PremiÃ¨re exÃ©cution, utilisation de HEAD~1 : $LAST_SHA"
            fi
          else
            LAST_SHA=$(git rev-parse HEAD~1)
            echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
            echo "ğŸ†• Aucun cache trouvÃ©, utilisation de HEAD~1 : $LAST_SHA"
          fi
      
      - name: DÃ©tecter les changements dans /content
        id: detect-changes
        run: |
          LAST_SHA="${{ steps.reference-sha.outputs.sha }}"
          CURRENT_SHA=$(git rev-parse HEAD)
          
          echo "ğŸ” Comparaison entre $LAST_SHA et $CURRENT_SHA"
          
          if git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep -q "^content/"; then
            CHANGED_COUNT=$(git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep "^content/" | wc -l)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$CHANGED_COUNT" >> $GITHUB_OUTPUT
            
            echo "âœ… $CHANGED_COUNT fichier(s) modifiÃ©(s) dans /content/ :"
            git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep "^content/"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dans /content/"
          fi
      
      - name: DÃ©clencher le build Cloudflare
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ DÃ©clenchement du build Cloudflare..."
          
          WEBHOOK_URL="${{ secrets.CLOUDFLARE_BUILD_WEBHOOK }}"
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âŒ CLOUDFLARE_BUILD_WEBHOOK non configurÃ©"
            exit 1
          fi
          
          CURRENT_SHA=$(git rev-parse HEAD)
          
          HTTP_CODE=$(curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"branch\": \"enka-next\",
              \"trigger\": \"github-cron\",
              \"commit_sha\": \"$CURRENT_SHA\"
            }" \
            -w "%{http_code}" \
            -s -o /dev/null)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Webhook appelÃ© avec succÃ¨s (HTTP $HTTP_CODE)"
          else
            echo "âŒ Erreur webhook (HTTP $HTTP_CODE)"
            exit 1
          fi
      
      # Sauvegarder le SHA dans le cache (que des changements aient Ã©tÃ© dÃ©tectÃ©s ou non)
      - name: Sauvegarder le SHA actuel dans le cache
        if: success()  # â† Seulement si tout s'est bien passÃ©
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "$CURRENT_SHA" > last-sha.txt
          echo "ğŸ’¾ SHA sauvegardÃ© pour la prochaine exÃ©cution : $CURRENT_SHA"
      
      - name: Mettre Ã  jour le cache
        if: success()  # â† Seulement si tout s'est bien passÃ©
        uses: actions/cache/save@v4
        with:
          path: last-sha.txt
          key: last-successful-build-sha-${{ github.ref }}-${{ github.run_id }}
      
      - name: RÃ©sumÃ©
        if: always()
        run: |
          if [ "${{ steps.detect-changes.outputs.has_changes }}" = "true" ]; then
            echo "ğŸ‰ Build dÃ©clenchÃ© pour ${{ steps.detect-changes.outputs.changed_files }} fichier(s)"
          else
            echo "ğŸ˜´ Aucun build nÃ©cessaire"
          fi
