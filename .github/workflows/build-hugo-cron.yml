name: Build Hugo (Cron si modifications dans /content)

on:
  schedule:
    # ExÃ©cution toutes les 3 heures (cron basÃ© sur UTC)
    - cron: '0 */3 * * *'
  
  # Permet aussi un dÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:

permissions:
  contents: write  # NÃ©cessaire pour commit le fichier last-sha.txt

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          ref: enka-next
          fetch-depth: 0  # NÃ©cessaire pour git diff sur l'historique complet
      
      - name: RÃ©cupÃ©rer le dernier SHA rÃ©ussi
        id: last-sha
        run: |
          # Lire le SHA depuis le fichier last-sha.txt
          if [ -f "last-sha.txt" ]; then
            LAST_SHA=$(cat last-sha.txt)
            
            # VÃ©rifier si le SHA est valide (existe dans le repo)
            if git rev-parse "$LAST_SHA" >/dev/null 2>&1; then
              echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
              echo "Dernier build rÃ©ussi (lu depuis last-sha.txt) : $LAST_SHA"
            else
              echo "SHA invalide dans last-sha.txt, utilisation de HEAD~1"
              LAST_SHA=$(git rev-parse HEAD~1)
              echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
            fi
          else
            echo "Fichier last-sha.txt introuvable, premiÃ¨re exÃ©cution"
            LAST_SHA=$(git rev-parse HEAD~1)
            echo "sha=$LAST_SHA" >> $GITHUB_OUTPUT
            echo "Dernier build rÃ©ussi : $LAST_SHA (dÃ©faut : HEAD~1)"
          fi
      
      - name: DÃ©tecter les changements dans /content
        id: detect-changes
        run: |
          LAST_SHA="${{ steps.last-sha.outputs.sha }}"
          CURRENT_SHA=$(git rev-parse HEAD)
          
          echo "VÃ©rification des changements entre $LAST_SHA et $CURRENT_SHA"
          
          # VÃ©rifier s'il y a des changements dans le dossier content/
          if git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep -q "^content/"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$(git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep "^content/" | wc -l)" >> $GITHUB_OUTPUT
            
            echo "âœ… Changements dÃ©tectÃ©s dans /content/ :"
            git diff --name-only "$LAST_SHA" "$CURRENT_SHA" | grep "^content/"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dans /content/ depuis le dernier build"
          fi
      
      - name: Afficher les fichiers modifiÃ©s (debug)
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "Tous les fichiers modifiÃ©s depuis le dernier build :"
          git diff --name-only "${{ steps.last-sha.outputs.sha }}" HEAD
      
      - name: DÃ©clencher le build Cloudflare
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ DÃ©clenchement du webhook Cloudflare Pages..."
          
          # Remplacez URL par votre vÃ©ritable webhook Cloudflare
          WEBHOOK_URL="${{ secrets.CLOUDFLARE_BUILD_WEBHOOK }}"
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âŒ Erreur : La variable CLOUDFLARE_BUILD_WEBHOOK n'est pas configurÃ©e"
            echo "Veuillez l'ajouter dans : Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          # Appel du webhook avec les informations de build
          RESPONSE=$(curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "enka-next",
              "trigger": "github-cron",
              "commit_sha": "'"$(git rev-parse HEAD)"'"
            }' \
            -w "\n%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "RÃ©ponse du webhook : $BODY"
          echo "Code HTTP : $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Webhook appelÃ© avec succÃ¨s"
          else
            echo "âš ï¸ Le webhook a rÃ©pondu avec le code $HTTP_CODE"
          fi
      
      - name: Mettre Ã  jour le SHA du dernier build rÃ©ussi
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Mise Ã  jour de last-sha.txt avec le SHA : $CURRENT_SHA"
          
          # Ã‰crire le nouveau SHA dans le fichier
          echo "$CURRENT_SHA" > last-sha.txt
          
          # Configurer git pour le commit automatique
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit et push du fichier mis Ã  jour
          git add last-sha.txt
          git commit -m "chore: update last-sha.txt to $CURRENT_SHA"
          git push
      
      - name: RÃ©sumÃ©
        if: always()
        run: |
          if [ "${{ steps.detect-changes.outputs.has_changes }}" = "true" ]; then
            echo "ğŸ‰ Build dÃ©clenchÃ© : ${{ steps.detect-changes.outputs.changed_files }} fichiers modifiÃ©s"
          else
            echo "ğŸ˜´ Aucun build nÃ©cessaire : pas de changements dans /content/"
          fi
