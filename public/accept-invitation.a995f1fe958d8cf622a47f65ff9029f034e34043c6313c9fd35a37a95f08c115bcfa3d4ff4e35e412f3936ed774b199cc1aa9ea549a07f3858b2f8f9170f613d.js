(()=>{var c={endpoint:"https://cloud.appwrite.io/v1",projectId:"689725820024e81781b7",databaseId:"689d15b10003a5a13636",functions:{cmsAuth:"68976500002eb5c6ee4f",accessRequest:"689cdea5001a4d74549d",batchUpdate:"68f00487000c624533a3"},collections:{main:"main",purchases:"purchases",products:"products"}},a=null,p=null,m=null,w=null,g=null,h=null;function k(e=50,t=100){return new Promise((n,o)=>{let r=0;function i(){r++,window.Appwrite&&window.Appwrite.Client&&window.Appwrite.Account?n():r>=e?(console.error("[Appwrite Client] SDK Appwrite non charg\xE9 apr\xE8s le nombre maximum de tentatives"),o(new Error("Le SDK Appwrite n'a pas pu \xEAtre charg\xE9."))):setTimeout(i,t)}i()})}async function d(){return a&&p&&m&&w?{client:a,account:p,functions:m,databases:w}:h||(h=(async()=>{try{console.log("[Appwrite Client] D\xE9but de l'initialisation"),await k();let{Client:e,Account:t,Functions:n,Databases:o,Teams:r}=window.Appwrite;return a=new e().setEndpoint(c.endpoint).setProject(c.projectId),p=new t(a),m=new n(a),w=new o(a),g=new r(a),console.log("[Appwrite Client] Initialisation termin\xE9e avec succ\xE8s"),{client:a,account:p,functions:m,databases:w,teams:g}}catch(e){throw console.error("[Appwrite Client] Erreur lors de l'initialisation:",e),a=null,p=null,m=null,w=null,g=null,h=null,e}})(),h)}async function M(){return await d()}async function u(){return p||await d(),p}async function U(){return g||await d(),g}async function b(){return m||await d(),m}async function V(){return w||await d(),w}function S(){return{APPWRITE_ENDPOINT:c.endpoint,APPWRITE_PROJECT_ID:c.projectId,APPWRITE_FUNCTION_ID:c.functions.cmsAuth,ACCESS_REQUEST_FUNCTION_ID:c.functions.accessRequest,APPWRITE_CONFIG:c}}function F(){return!!(a&&p&&m&&w&&g)}function T(){let e=localStorage.getItem("sveltia-cms.user");if(!e)return null;try{let t=JSON.parse(e);return t.token&&typeof t.token=="string"&&t.token.trim()!==""?t:(localStorage.removeItem("sveltia-cms.user"),null)}catch{return localStorage.removeItem("sveltia-cms.user"),null}}function j(){return T()!==null}async function q(){try{return await(await u()).get(),!0}catch{return!1}}async function G(){try{let e=await u(),t=await e.get();if(!t||!t.$id)return!1;let n=await e.getSession("current");if(!n||!n.$id)return!1;let o=new Date,r=new Date(n.expire);return!(o>=r)}catch(e){return console.error("Error checking connection:",e),!1}}async function z(){try{return(await(await u()).get()).emailVerification||!1}catch{return!1}}async function J(e=null){try{let t=await u(),n=e||`${window.location.origin}/verify-email`;await t.createVerification(n)}catch(t){throw console.error("[AppwriteClient] Erreur lors de l'envoi de l'email de v\xE9rification:",t),t}}async function W(e,t){try{await(await u()).updateVerification(e,t)}catch(n){throw console.error("[AppwriteClient] Erreur lors de la v\xE9rification d'email:",n),n}}function H(){return localStorage.getItem("appwrite-user-email")}function K(){return localStorage.getItem("appwrite-user-name")}function Q(){return localStorage.getItem("email-verification-status")}function $(){localStorage.removeItem("sveltia-cms.user"),localStorage.removeItem("appwrite-user-email"),localStorage.removeItem("appwrite-user-name"),localStorage.removeItem("email-verification-status")}async function X(e){console.log(`[Appwrite Client] Validation des donn\xE9es pour l'\xE9v\xE9nement ${e}`);let t=await fetch(`/evenements/${e}/ingredients_aw/index.json`);if(!t.ok)throw new Error(`Impossible de r\xE9cup\xE9rer les donn\xE9es de l'\xE9v\xE9nement: ${t.status}`);let n=await t.json();console.log("[Appwrite Client] Donn\xE9es de l'\xE9v\xE9nement r\xE9cup\xE9r\xE9es:",n);let{account:o,databases:r}=await d(),i=await o.get();console.log(`[Appwrite Client] Utilisateur authentifi\xE9: ${i.$id}`);try{return await r.getDocument(c.databaseId,c.collections.main,e),console.log(`[Appwrite Client] L'\xE9v\xE9nement ${e} existe d\xE9j\xE0 dans main`),window.location.href=`/sv_products/?listId=${e}`,null}catch(l){if(l.code!==404)throw l}let s=window.__HUGO_PARAMS__?.listContentHash;if(!s)throw new Error("Le hash du contenu n'est pas d\xE9fini");return{eventData:n,user:i,contentHash:s}}async function Y(e,t,n,o){console.log(`[Appwrite Client] Appel de la fonction serveur pour ${e}`);let r=c.functions.createProductList,{functions:i}=await d();try{let s=await i.createExecution(r,JSON.stringify({eventId:e,eventData:t,userId:n,contentHash:o}),!0,"/","GET",{});console.log("[Appwrite Client] Ex\xE9cution d\xE9marr\xE9e en mode asynchrone:",s);let l=s.$id;return console.log(`[Appwrite Client] Execution ID: ${l}`),console.log("[Appwrite Client] Ex\xE9cution async d\xE9marr\xE9e pour 300+ ingr\xE9dients - pas de polling"),{success:!0,eventId:e,executionId:l,message:"Traitement d\xE9marr\xE9 en arri\xE8re-plan (300+ ingr\xE9dients)",isAsync:!0}}catch(s){throw console.error("[Appwrite Client] Erreur lors de l'appel fonction:",s),s}}async function Z(e){try{console.log(`[Appwrite Client] D\xE9but de la cr\xE9ation pour l'\xE9v\xE9nement ${e}`);let t=await X(e);if(!t)return;let{eventData:n,user:o,contentHash:r}=t;console.log("[Appwrite Client] Donn\xE9es valid\xE9es, appel de la fonction");let i=await Y(e,n,o.$id,r);console.log("[Appwrite Client] Op\xE9ration r\xE9ussie, redirection vers la liste"),window.location.href=`/sv_products/?listId=${e}`}catch(t){throw console.error("[Appwrite Client] Erreur lors de la cr\xE9ation:",t.message),t.message.includes("already_exists")?new Error("Cette liste de produits existe d\xE9j\xE0. Veuillez r\xE9essayer avec un ID diff\xE9rent."):t.message.includes("transaction_limit_exceeded")?new Error("Limite de transactions d\xE9pass\xE9e. Veuillez r\xE9duire le nombre d'ingr\xE9dients ou r\xE9essayer plus tard."):t}}async function ee(e){try{let{databases:t}=await d();return!!await t.getDocument("689d15b10003a5a13636","main",e)}catch(t){return t.code===404||console.error("[Appwrite Client] Erreur lors de la v\xE9rification du main group existant:",t),!1}}async function te(){try{$(),await(await u()).deleteSession("current")}catch(e){console.warn("[Appwrite Client] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}}function P(e,t,n){localStorage.setItem("appwrite-user-email",e),localStorage.setItem("appwrite-user-name",t),localStorage.setItem("sveltia-cms.user",JSON.stringify(n))}function ne(e,t,n,o={}){let{onConnect:r,onDisconnect:i,onError:s}=o;if(!a)return console.error("Impossible de s'abonner : le client Appwrite n'est pas encore initialis\xE9."),s?.({message:"Client Appwrite non initialis\xE9"}),()=>{};let l=e.map(f=>{let y=c.collections[f];return y?`databases.${c.databaseId}.collections.${y}.documents`:(console.warn(`[Appwrite Client] Nom de collection inconnu dans la configuration: ${f}`),null)}).filter(Boolean);console.log("[Appwrite Client] Abonnement aux canaux en cours...",l);try{let f=a.subscribe(l,y=>{console.log("[Appwrite Client] R\xE9ception temps r\xE9el:",y),n(y)});return r&&setTimeout(()=>{console.log("[Appwrite Client] Connexion temps r\xE9el \xE9tablie"),r()},50),f}catch(f){return console.error("[Appwrite Client] Erreur lors de la souscription temps r\xE9el:",f),s?.(f),()=>{}}}typeof window<"u"&&(window.AppwriteClient={getAppwriteClients:M,getAccount:u,getFunctions:b,getDatabases:V,getConfig:S,isInitialized:F,initializeAppwrite:d,getLocalCmsUser:T,isAuthenticatedCms:j,isAuthenticatedAppwrite:q,isConnectedAppwrite:G,getUserEmail:H,getUserName:K,clearAuthData:$,setAuthData:P,logoutGlobal:te,isEmailVerified:z,sendVerificationEmail:J,verifyEmail:W,getLocalEmailVerificationStatus:Q,createCollaborativeProductsListFromEvent:Z,checkExistingMainGroup:ee,subscribeToCollections:ne});var{APPWRITE_FUNCTION_ID:re}=S(),oe="689bf6fe0006627d8959",L=document.getElementById("accept-invitation-loading"),N=document.getElementById("accept-invitation-error"),I=document.getElementById("accept-invitation-success"),E=document.getElementById("error-message"),C=document.getElementById("set-password-section"),O=document.getElementById("set-password-form"),ie=document.getElementById("new-password"),se=document.getElementById("confirm-password"),x=document.getElementById("set-password-error"),v=document.getElementById("set-password-button"),_=v?.querySelector(".spinner-border"),D=document.getElementById("final-success-message");function A(e){L&&(L.style.display=e==="loading"?"block":"none"),N&&(N.style.display=e==="error"?"block":"none");let t=e==="success"||e==="setPassword";I&&(I.style.display=t?"block":"none"),C&&(C.style.display=e==="setPassword"?"block":"none")}function B(){return new URLSearchParams(window.location.search)}async function ae(){let t=await(await b()).createExecution(re,"",!1);if(t.responseStatusCode!==200){let o=t.responseBody;try{let r=JSON.parse(t.responseBody);r.error&&(o=r.error)}catch{}throw new Error(`Erreur de la fonction CMS (${t.responseStatusCode}): ${o}`)}return JSON.parse(t.responseBody)}async function ce(e,t){if(!e||e.length<8)throw new Error("Le mot de passe doit contenir au moins 8 caract\xE8res.");if(e!==t)throw new Error("Les mots de passe ne correspondent pas.");await(await u()).updatePassword(e)}async function le(){A("loading");try{let e=B(),t=e.get("teamId"),n=e.get("membershipId"),o=e.get("userId"),r=e.get("secret");if(!t||!n||!o||!r)throw new Error("Param\xE8tres d'invitation manquants dans l'URL.");if(t!==oe)throw new Error("Cette invitation n'est pas valide pour cette application.");await(await U()).updateMembershipStatus(t,n,o,r);let l=await(await u()).get();localStorage.setItem("appwrite-user-email",l.email),localStorage.setItem("appwrite-user-name",l.name),A("setPassword")}catch(e){console.error("Erreur lors de l'acceptation de l'invitation:",e);let t="Une erreur est survenue lors du traitement de votre invitation.";e.code===401?t="Cette invitation n'est pas valide ou a expir\xE9.":e.code===404?t="Cette invitation n'existe pas ou a expir\xE9.":e.code===409?t="Cette invitation a d\xE9j\xE0 \xE9t\xE9 accept\xE9e.":e.message&&(t=e.message),E&&(E.textContent=t),A("error")}}O&&O.addEventListener("submit",async e=>{e.preventDefault(),x.style.display="none",_.style.display="inline-block",v.disabled=!0;let t=ie.value,n=se.value;try{await ce(t,n);let r=await(await u()).get(),i=await ae();P(r.email,i),I&&(I.style.display="none"),C&&(C.style.display="none"),D&&(D.style.display="block")}catch(o){console.error("Erreur lors de la finalisation du compte:",o),ue(o.message)}finally{_.style.display="none",D.style.display!=="block"&&(v.disabled=!1)}});function ue(e){x.textContent=e,x.style.display="block",_.style.display="none",v.disabled=!1}async function R(){console.log("\u{1F680} [Accept-Invitation] Initialisation du traitement");let e=B();console.log("\u{1F4CB} [Accept-Invitation] Param\xE8tres URL:",{hasTeamId:e.has("teamId"),hasMembershipId:e.has("membershipId"),hasUserId:e.has("userId"),hasSecret:e.has("secret"),teamId:e.get("teamId"),membershipId:e.get("membershipId"),userId:e.get("userId"),secret:e.get("secret")?"***":null}),e.has("teamId")&&e.has("membershipId")&&e.has("userId")&&e.has("secret")?le():(E&&(E.textContent="Aucune invitation trouv\xE9e dans l'URL. Veuillez v\xE9rifier le lien d'invitation."),A("error"))}document.readyState==="loading"?(console.log("\u23F3 [Accept-Invitation] DOM en cours de chargement, attente de DOMContentLoaded"),document.addEventListener("DOMContentLoaded",R)):(console.log("\u2705 [Accept-Invitation] DOM d\xE9j\xE0 charg\xE9, ex\xE9cution imm\xE9diate"),R());})();
