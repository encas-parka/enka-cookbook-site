(()=>{var u={endpoint:"https://cloud.appwrite.io/v1",projectId:"689725820024e81781b7",databaseId:"689d15b10003a5a13636",functions:{cmsAuth:"68976500002eb5c6ee4f",accessRequest:"689cdea5001a4d74549d",batchUpdate:"68f00487000c624533a3"},collections:{main:"main",purchases:"purchases",products:"products"}},d=null,g=null,w=null,y=null,U=null,x=null;function oe(e=50,t=100){return new Promise((n,i)=>{let o=0;function s(){o++,window.Appwrite&&window.Appwrite.Client&&window.Appwrite.Account?n():o>=e?(console.error("[Appwrite Client] SDK Appwrite non charg\xE9 apr\xE8s le nombre maximum de tentatives"),i(new Error("Le SDK Appwrite n'a pas pu \xEAtre charg\xE9."))):setTimeout(s,t)}s()})}async function E(){return d&&g&&w&&y?{client:d,account:g,functions:w,databases:y}:x||(x=(async()=>{try{console.log("[Appwrite Client] D\xE9but de l'initialisation"),await oe();let{Client:e,Account:t,Functions:n,Databases:i,Teams:o}=window.Appwrite;return d=new e().setEndpoint(u.endpoint).setProject(u.projectId),g=new t(d),w=new n(d),y=new i(d),U=new o(d),console.log("[Appwrite Client] Initialisation termin\xE9e avec succ\xE8s"),{client:d,account:g,functions:w,databases:y,teams:U}}catch(e){throw console.error("[Appwrite Client] Erreur lors de l'initialisation:",e),d=null,g=null,w=null,y=null,U=null,x=null,e}})(),x)}async function ie(){return await E()}async function l(){return g||await E(),g}async function V(){return w||await E(),w}async function re(){return y||await E(),y}function M(){return{APPWRITE_ENDPOINT:u.endpoint,APPWRITE_PROJECT_ID:u.projectId,APPWRITE_FUNCTION_ID:u.functions.cmsAuth,ACCESS_REQUEST_FUNCTION_ID:u.functions.accessRequest,APPWRITE_CONFIG:u}}function se(){return!!(d&&g&&w&&y&&U)}function C(){let e=localStorage.getItem("sveltia-cms.user");if(!e)return null;try{let t=JSON.parse(e);return t.token&&typeof t.token=="string"&&t.token.trim()!==""?t:(localStorage.removeItem("sveltia-cms.user"),null)}catch{return localStorage.removeItem("sveltia-cms.user"),null}}function ae(){return C()!==null}async function le(){try{return await(await l()).get(),!0}catch{return!1}}async function ce(){try{let e=await l(),t=await e.get();if(!t||!t.$id)return!1;let n=await e.getSession("current");if(!n||!n.$id)return!1;let i=new Date,o=new Date(n.expire);return!(i>=o)}catch(e){return console.error("Error checking connection:",e),!1}}async function de(){try{return(await(await l()).get()).emailVerification||!1}catch{return!1}}async function j(e=null){try{let t=await l(),n=e||`${window.location.origin}/verify-email`;await t.createVerification(n)}catch(t){throw console.error("[AppwriteClient] Erreur lors de l'envoi de l'email de v\xE9rification:",t),t}}async function ue(e,t){try{await(await l()).updateVerification(e,t)}catch(n){throw console.error("[AppwriteClient] Erreur lors de la v\xE9rification d'email:",n),n}}function pe(){return localStorage.getItem("appwrite-user-email")}function me(){return localStorage.getItem("appwrite-user-name")}function fe(){return localStorage.getItem("email-verification-status")}function h(){localStorage.removeItem("sveltia-cms.user"),localStorage.removeItem("appwrite-user-email"),localStorage.removeItem("appwrite-user-name"),localStorage.removeItem("email-verification-status")}async function ge(e){console.log(`[Appwrite Client] Validation des donn\xE9es pour l'\xE9v\xE9nement ${e}`);let t=await fetch(`/evenements/${e}/ingredients_aw/index.json`);if(!t.ok)throw new Error(`Impossible de r\xE9cup\xE9rer les donn\xE9es de l'\xE9v\xE9nement: ${t.status}`);let n=await t.json();console.log("[Appwrite Client] Donn\xE9es de l'\xE9v\xE9nement r\xE9cup\xE9r\xE9es:",n);let{account:i,databases:o}=await E(),s=await i.get();console.log(`[Appwrite Client] Utilisateur authentifi\xE9: ${s.$id}`);try{return await o.getDocument(u.databaseId,u.collections.main,e),console.log(`[Appwrite Client] L'\xE9v\xE9nement ${e} existe d\xE9j\xE0 dans main`),window.location.href=`/sv_products/?listId=${e}`,null}catch(c){if(c.code!==404)throw c}let r=window.__HUGO_PARAMS__?.listContentHash;if(!r)throw new Error("Le hash du contenu n'est pas d\xE9fini");return{eventData:n,user:s,contentHash:r}}async function we(e,t,n,i){console.log(`[Appwrite Client] Appel de la fonction serveur pour ${e}`);let o=u.functions.createProductList,{functions:s}=await E();try{let r=await s.createExecution(o,JSON.stringify({eventId:e,eventData:t,userId:n,contentHash:i}),!0,"/","GET",{});console.log("[Appwrite Client] Ex\xE9cution d\xE9marr\xE9e en mode asynchrone:",r);let c=r.$id;return console.log(`[Appwrite Client] Execution ID: ${c}`),console.log("[Appwrite Client] Ex\xE9cution async d\xE9marr\xE9e pour 300+ ingr\xE9dients - pas de polling"),{success:!0,eventId:e,executionId:c,message:"Traitement d\xE9marr\xE9 en arri\xE8re-plan (300+ ingr\xE9dients)",isAsync:!0}}catch(r){throw console.error("[Appwrite Client] Erreur lors de l'appel fonction:",r),r}}async function ye(e){try{console.log(`[Appwrite Client] D\xE9but de la cr\xE9ation pour l'\xE9v\xE9nement ${e}`);let t=await ge(e);if(!t)return;let{eventData:n,user:i,contentHash:o}=t;console.log("[Appwrite Client] Donn\xE9es valid\xE9es, appel de la fonction");let s=await we(e,n,i.$id,o);console.log("[Appwrite Client] Op\xE9ration r\xE9ussie, redirection vers la liste"),window.location.href=`/sv_products/?listId=${e}`}catch(t){throw console.error("[Appwrite Client] Erreur lors de la cr\xE9ation:",t.message),t.message.includes("already_exists")?new Error("Cette liste de produits existe d\xE9j\xE0. Veuillez r\xE9essayer avec un ID diff\xE9rent."):t.message.includes("transaction_limit_exceeded")?new Error("Limite de transactions d\xE9pass\xE9e. Veuillez r\xE9duire le nombre d'ingr\xE9dients ou r\xE9essayer plus tard."):t}}async function Ee(e){try{let{databases:t}=await E();return!!await t.getDocument("689d15b10003a5a13636","main",e)}catch(t){return t.code===404||console.error("[Appwrite Client] Erreur lors de la v\xE9rification du main group existant:",t),!1}}async function he(){try{h(),await(await l()).deleteSession("current")}catch(e){console.warn("[Appwrite Client] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}}function S(e,t,n){localStorage.setItem("appwrite-user-email",e),localStorage.setItem("appwrite-user-name",t),localStorage.setItem("sveltia-cms.user",JSON.stringify(n))}function Ae(e,t,n,i={}){let{onConnect:o,onDisconnect:s,onError:r}=i;if(!d)return console.error("Impossible de s'abonner : le client Appwrite n'est pas encore initialis\xE9."),r?.({message:"Client Appwrite non initialis\xE9"}),()=>{};let c=e.map(p=>{let m=u.collections[p];return m?`databases.${u.databaseId}.collections.${m}.documents`:(console.warn(`[Appwrite Client] Nom de collection inconnu dans la configuration: ${p}`),null)}).filter(Boolean);console.log("[Appwrite Client] Abonnement aux canaux en cours...",c);try{let p=d.subscribe(c,m=>{console.log("[Appwrite Client] R\xE9ception temps r\xE9el:",m),n(m)});return o&&setTimeout(()=>{console.log("[Appwrite Client] Connexion temps r\xE9el \xE9tablie"),o()},50),p}catch(p){return console.error("[Appwrite Client] Erreur lors de la souscription temps r\xE9el:",p),r?.(p),()=>{}}}typeof window<"u"&&(window.AppwriteClient={getAppwriteClients:ie,getAccount:l,getFunctions:V,getDatabases:re,getConfig:M,isInitialized:se,initializeAppwrite:E,getLocalCmsUser:C,isAuthenticatedCms:ae,isAuthenticatedAppwrite:le,isConnectedAppwrite:ce,getUserEmail:pe,getUserName:me,clearAuthData:h,setAuthData:S,logoutGlobal:he,isEmailVerified:de,sendVerificationEmail:j,verifyEmail:ue,getLocalEmailVerificationStatus:fe,createCollaborativeProductsListFromEvent:ye,checkExistingMainGroup:Ee,subscribeToCollections:Ae});var{APPWRITE_FUNCTION_ID:be,ACCESS_REQUEST_FUNCTION_ID:ve}=M();function z(){let t=new URLSearchParams(window.location.search).get("redirect");return t&&t.startsWith("/")&&!t.startsWith("//")?t:null}var B=document.getElementById("loading-state"),N=document.getElementById("user-logged-in"),k=document.getElementById("user-logged-out"),A=document.getElementById("logged-out-sections"),W=document.getElementById("login-form"),J=document.getElementById("logout-button"),f=document.getElementById("error-message"),L=document.getElementById("login-button"),R=L?.querySelector(".spinner-border"),O=document.getElementById("user-email-display"),H=document.getElementById("user-encas-gmx"),K=document.getElementById("welcome-user"),b=document.getElementById("header-logged-out"),v=document.getElementById("header-logged-in"),_=document.getElementById("email-not-verified"),I=document.getElementById("resend-verification"),Q=document.getElementById("logout-button-unverified"),T=document.getElementById("info-message"),X=document.getElementById("user-email-to-verify"),F=document.getElementById("email-pwd-login"),$=document.getElementById("password-forgotten"),Y=document.getElementById("forgot-password-button"),Z=document.getElementById("password-forgotten-form"),P=document.getElementById("submit-password-forgotten"),q=P?.querySelector(".spinner-border");function a(e,t=""){switch(B&&(B.style.display="none"),N&&(N.style.display="none"),k&&(k.style.display="none"),_&&(_.style.display="none"),A&&(A.style.display="none"),F&&(F.style.display="none"),$&&($.style.display="none"),e){case"loading":B&&(B.style.display="block");break;case"loggedIn":N&&(N.style.display="block"),v&&(v.style.display="flex"),b&&(b.style.display="none");let n=localStorage.getItem("appwrite-user-name");H&&n==="encas-cookbook"?H.style.display="block":K&&n&&(K.textContent=`Bienvenue ${n}`);break;case"loggedOut":k&&(k.style.display="block"),A&&(A.style.display="flex"),F&&(F.style.display="block"),b&&(b.style.display="flex"),v&&(v.style.display="none");break;case"emailNotVerified":_&&(_.style.display="block"),A&&(A.style.display="flex"),b&&(b.style.display="flex"),v&&(v.style.display="none");break;case"forgotPassword":k&&(k.style.display="block"),A&&(A.style.display="flex"),$&&($.style.display="block"),b&&(b.style.display="flex"),v&&(v.style.display="none");break}f&&t?(f.textContent=t,f.style.display="block"):f&&(f.style.display="none"),T&&(e==="emailNotVerified"&&t&&t.includes("succ\xE8s")?(T.textContent=t,T.style.display="block"):T.style.display="none")}async function Ie(e){e.preventDefault(),console.log("[AuthAppwrite] Soumission du formulaire de mot de passe oubli\xE9");let t=document.getElementById("email"),n=t?t.value:"";if(!n){a("forgotPassword","Veuillez entrer votre adresse email.");return}P&&(P.disabled=!0),q&&(q.style.display="inline-block"),f&&(f.style.display="none");try{let i=await l(),o=`${window.location.origin}/reset-password`;await i.createRecovery(n,o),console.log("[AuthAppwrite] Email de r\xE9initialisation de mot de passe envoy\xE9."),a("loggedOut","Un email de r\xE9initialisation de mot de passe a \xE9t\xE9 envoy\xE9 \xE0 votre adresse. Veuillez v\xE9rifier votre bo\xEEte de r\xE9ception.")}catch(i){console.error("[AuthAppwrite] Erreur lors de l'envoi de l'email de r\xE9initialisation:",i);let o="Une erreur est survenue lors de l'envoi de l'email de r\xE9initialisation.";i.response&&i.response.code===404&&(o="Aucun compte n'est associ\xE9 \xE0 cette adresse email."),a("forgotPassword",o)}finally{P&&(P.disabled=!1),q&&(q.style.display="none")}}function Ce(e){e.preventDefault(),a("forgotPassword")}async function te(){let e=await l(),t=await V();try{let n=await e.get();if(!n.emailVerification)throw new Error("EMAIL_NOT_VERIFIED");let i=JSON.stringify({email:n.email}),o=await t.createExecution(be,i,!1,`/cms-auth/${n.email}`,"POST"),s=JSON.parse(o.responseBody);if(s&&s.token){let r={token:s.token,id:s.user_id,email:n.email,name:n.name,backendName:"appwrite"};return S(n.email,n.name,r),r}else throw console.error("\u274C [setupCmsAuthentication] R\xE9ponse de la fonction CMS invalide:",s),new Error("Token CMS manquant dans la r\xE9ponse de la fonction.")}catch(n){throw console.error("\u274C [setupCmsAuthentication] Erreur dans setupCmsAuthentication:",n),n}}async function Se(){a("loading");try{if(!window.Appwrite)throw console.error("\u274C [handleLoginPageLoad] SDK Appwrite non disponible !"),new Error("SDK Appwrite non charg\xE9");let e=await l(),t=C(),n=null;try{n=await e.get()}catch{}let i=t&&t.token&&typeof t.token=="string"&&t.token.trim()!==""&&t.token!=="[]"&&t.token!=="undefined"&&t.token!=="null";if(n&&i){S(n.email,n.name,t),O&&(O.textContent=` (${n.email})`),a("loggedIn");let o=z();o&&(console.log("[AuthAppwrite] Utilisateur d\xE9j\xE0 authentifi\xE9, redirection vers:",o),window.location.href=o);return}if(n&&!i)try{await te();let o=C();if(o&&o.token&&typeof o.token=="string"&&o.token.trim()!==""&&o.token!=="[]"){S(n.email,n.name,o),O&&(O.textContent=` (${n.email})`),a("loggedIn");let r=z();r&&(console.log("[AuthAppwrite] Token CMS r\xE9cup\xE9r\xE9, redirection vers:",r),window.location.href=r);return}else throw console.error("\u274C [handleLoginPageLoad] \xC9chec de r\xE9cup\xE9ration du token CMS"),new Error("Impossible de r\xE9cup\xE9rer le token CMS")}catch(o){if(console.error("\u274C [handleLoginPageLoad] Erreur lors de la r\xE9cup\xE9ration du tokpen CMS:",o),o.message==="EMAIL_NOT_VERIFIED"){console.warn("\u26A0\uFE0F [handleLoginPageLoad] Email non v\xE9rifi\xE9 - affichage du message appropri\xE9"),X&&n&&(X.textContent=n.email),a("emailNotVerified");return}try{await e.deleteSession("current")}catch(s){console.warn("Erreur lors du nettoyage de la session Appwrite:",s)}h(),a("loggedOut");return}if(!n&&i){h(),a("loggedOut");return}h(),a("loggedOut")}catch(e){console.error("\u274C ERREUR CRITIQUE [handleLoginPageLoad]:",e.message),h(),a("loggedOut")}}async function ke(e){e.preventDefault(),L&&(L.disabled=!0),R&&(R.style.display="inline-block"),f&&(f.style.display="none");let t=document.getElementById("login-email").value,n=document.getElementById("login-password").value;try{let o=await(await l()).createEmailPasswordSession(t,n);await te();let s=C();if(s)S(t,o.providerUid,s),xe();else throw console.error("\u274C [handleLoginSubmit] Impossible de r\xE9cup\xE9rer le token CMS apr\xE8s la connexion."),new Error("Impossible de r\xE9cup\xE9rer le token CMS.")}catch(i){console.error("\u274C [handleLoginSubmit] Erreur de connexion:",i);let o="\xC9chec de la connexion. Veuillez v\xE9rifier vos identifiants.";if(i.code===401||i.code===400)o="Email ou mot de passe incorrect.";else if(i.message==="EMAIL_NOT_VERIFIED"){o="Votre email n'est pas v\xE9rifi\xE9. Veuillez v\xE9rifier votre bo\xEEte de r\xE9ception ou cliquer sur 'Renvoyer l'email'.",a("emailNotVerified",o);return}else i.message.includes("Account with the given email already exists")&&(o="Un compte avec cet email existe d\xE9j\xE0.");a("loggedOut",o)}finally{L&&(L.disabled=!1),R&&(R.style.display="none")}}function xe(){let e=z();e?window.location.href=e:window.location.reload()}async function ee(){h();try{await(await l()).deleteSession("current"),console.log("\u2705 [handleLogout] D\xE9connexion Appwrite r\xE9ussie.")}catch(e){console.warn("\u26A0\uFE0F [handleLogout] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}finally{window.location.reload()}}async function Le(){I&&(I.disabled=!0);let e=I?.querySelector(".spinner-border");e&&(e.style.display="inline-block");try{await j(),a("emailNotVerified","Email de v\xE9rification renvoy\xE9 avec succ\xE8s ! Veuillez v\xE9rifier votre bo\xEEte de r\xE9ception.")}catch(t){console.error("\u274C [handleResendVerification] Erreur lors du renvoi de l'email de v\xE9rification:",t),a("emailNotVerified","Erreur lors du renvoi de l'email de v\xE9rification. Veuillez r\xE9essayer plus tard.")}finally{I&&(I.disabled=!1),e&&(e.style.display="none")}}async function Pe(e){e.preventDefault();let t=e.target,n=t.querySelector("#Form-submit"),i=n.querySelector(".spinner-border"),o=t.querySelector("#contact-form-email"),s=t.querySelector("#contact-form-message"),r=document.getElementById("form-feedback");n&&(n.disabled=!0),i&&(i.style.display="inline-block"),r&&(r.style.display="none",r.className="mb-3");let c=o.value,p=s.value;if(!c||!p){r&&(r.textContent="Veuillez remplir tous les champs.",r.classList.add("alert","alert-danger"),r.style.display="block"),n&&(n.disabled=!1),i&&(i.style.display="none");return}try{let m=await V(),G=JSON.stringify({email:c,message:p});console.log("[AccessRequest] Appel de la fonction de demande d'acc\xE8s avec payload:",G);let D=await m.createExecution(ve,G,!1,`/access-request/${c}`,"POST");if(console.log("[AccessRequest] Ex\xE9cution de la fonction Appwrite r\xE9ussie:",D),D.statusCode===200)r&&(r.textContent="Votre demande d'acc\xE8s a \xE9t\xE9 envoy\xE9e avec succ\xE8s ! Nous vous recontacterons bient\xF4t.",r.classList.add("alert","alert-success"),r.style.display="block"),t.reset();else{let ne=JSON.parse(D.responseBody);throw new Error(ne.message||`Erreur Appwrite: ${D.statusCode}`)}}catch(m){console.error("[AccessRequest] Erreur lors de l'envoi de la demande d'acc\xE8s:",m),r&&(r.textContent=`Erreur : ${m.message||"Une erreur est survenue lors de l'envoi de votre demande."}`,r.classList.add("alert","alert-danger"),r.style.display="block")}finally{n&&(n.disabled=!1),i&&(i.style.display="none")}}document.addEventListener("DOMContentLoaded",()=>{Se(),W&&W.addEventListener("submit",ke),J&&J.addEventListener("click",ee),Q&&Q.addEventListener("click",ee),I&&I.addEventListener("click",Le),Y&&Y.addEventListener("click",Ce),Z&&Z.addEventListener("submit",Ie);let e=document.getElementById("access-request-form");e&&e.addEventListener("submit",Pe)});})();
