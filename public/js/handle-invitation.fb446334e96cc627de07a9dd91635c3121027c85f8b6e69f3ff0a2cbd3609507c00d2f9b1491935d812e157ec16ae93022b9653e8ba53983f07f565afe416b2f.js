(()=>{var c={endpoint:"https://cloud.appwrite.io/v1",projectId:"689725820024e81781b7",databaseId:"689d15b10003a5a13636",functions:{cmsAuth:"68976500002eb5c6ee4f",accessRequest:"689cdea5001a4d74549d",batchUpdate:"68f00487000c624533a3"},collections:{main:"main",purchases:"purchases",products:"products"}},s=null,w=null,g=null,E=null,v=null,y=null;function P(e=50,t=100){return new Promise((n,r)=>{let i=0;function l(){i++,window.Appwrite&&window.Appwrite.Client&&window.Appwrite.Account?n():i>=e?(console.error("[Appwrite Client] SDK Appwrite non charg\xE9 apr\xE8s le nombre maximum de tentatives"),r(new Error("Le SDK Appwrite n'a pas pu \xEAtre charg\xE9."))):setTimeout(l,t)}l()})}async function u(){return s&&w&&g&&E?{client:s,account:w,functions:g,databases:E}:y||(y=(async()=>{try{console.log("[Appwrite Client] D\xE9but de l'initialisation"),await P();let{Client:e,Account:t,Functions:n,Databases:r,Teams:i}=window.Appwrite;return s=new e().setEndpoint(c.endpoint).setProject(c.projectId),w=new t(s),g=new n(s),E=new r(s),v=new i(s),console.log("[Appwrite Client] Initialisation termin\xE9e avec succ\xE8s"),{client:s,account:w,functions:g,databases:E,teams:v}}catch(e){throw console.error("[Appwrite Client] Erreur lors de l'initialisation:",e),s=null,w=null,g=null,E=null,v=null,y=null,e}})(),y)}async function N(){return await u()}async function d(){return w||await u(),w}async function _(){return v||await u(),v}async function O(){return g||await u(),g}async function V(){return E||await u(),E}function D(){return{APPWRITE_ENDPOINT:c.endpoint,APPWRITE_PROJECT_ID:c.projectId,APPWRITE_FUNCTION_ID:c.functions.cmsAuth,ACCESS_REQUEST_FUNCTION_ID:c.functions.accessRequest,APPWRITE_CONFIG:c}}function q(){return!!(s&&w&&g&&E&&v)}function $(){let e=localStorage.getItem("sveltia-cms.user");if(!e)return null;try{let t=JSON.parse(e);return t.token&&typeof t.token=="string"&&t.token.trim()!==""?t:(localStorage.removeItem("sveltia-cms.user"),null)}catch{return localStorage.removeItem("sveltia-cms.user"),null}}function L(){return $()!==null}async function j(){try{return await(await d()).get(),!0}catch{return!1}}async function M(){try{let e=await d(),t=await e.get();if(!t||!t.$id)return!1;let n=await e.getSession("current");if(!n||!n.$id)return!1;let r=new Date,i=new Date(n.expire);return!(r>=i)}catch(e){return console.error("Error checking connection:",e),!1}}async function k(){try{return(await(await d()).get()).emailVerification||!1}catch{return!1}}async function z(e=null){try{let t=await d(),n=e||`${window.location.origin}/verify-email`;await t.createVerification(n)}catch(t){throw console.error("[AppwriteClient] Erreur lors de l'envoi de l'email de v\xE9rification:",t),t}}async function B(e,t){try{await(await d()).updateVerification(e,t)}catch(n){throw console.error("[AppwriteClient] Erreur lors de la v\xE9rification d'email:",n),n}}function F(){return localStorage.getItem("appwrite-user-email")}function G(){return localStorage.getItem("appwrite-user-name")}function J(){return localStorage.getItem("email-verification-status")}function R(){localStorage.removeItem("sveltia-cms.user"),localStorage.removeItem("appwrite-user-email"),localStorage.removeItem("appwrite-user-name"),localStorage.removeItem("email-verification-status")}async function W(e){console.log(`[Appwrite Client] Validation des donn\xE9es pour l'\xE9v\xE9nement ${e}`);let t=await fetch(`/evenements/${e}/ingredients_aw/index.json`);if(!t.ok)throw new Error(`Impossible de r\xE9cup\xE9rer les donn\xE9es de l'\xE9v\xE9nement: ${t.status}`);let n=await t.json();console.log("[Appwrite Client] Donn\xE9es de l'\xE9v\xE9nement r\xE9cup\xE9r\xE9es:",n);let{account:r,databases:i}=await u(),l=await r.get();console.log(`[Appwrite Client] Utilisateur authentifi\xE9: ${l.$id}`);try{return await i.getDocument(c.databaseId,c.collections.main,e),console.log(`[Appwrite Client] L'\xE9v\xE9nement ${e} existe d\xE9j\xE0 dans main`),window.location.href=`/sv_products/?listId=${e}`,null}catch(f){if(f.code!==404)throw f}let a=window.__HUGO_PARAMS__?.listContentHash;if(!a)throw new Error("Le hash du contenu n'est pas d\xE9fini");return{eventData:n,user:l,contentHash:a}}async function H(e,t,n,r){console.log(`[Appwrite Client] Appel de la fonction serveur pour ${e}`);let i=c.functions.createProductList,{functions:l}=await u();try{let a=await l.createExecution(i,JSON.stringify({eventId:e,eventData:t,userId:n,contentHash:r}),!0,"/","GET",{});console.log("[Appwrite Client] Ex\xE9cution d\xE9marr\xE9e en mode asynchrone:",a);let f=a.$id;return console.log(`[Appwrite Client] Execution ID: ${f}`),console.log("[Appwrite Client] Ex\xE9cution async d\xE9marr\xE9e pour 300+ ingr\xE9dients - pas de polling"),{success:!0,eventId:e,executionId:f,message:"Traitement d\xE9marr\xE9 en arri\xE8re-plan (300+ ingr\xE9dients)",isAsync:!0}}catch(a){throw console.error("[Appwrite Client] Erreur lors de l'appel fonction:",a),a}}async function K(e){try{console.log(`[Appwrite Client] D\xE9but de la cr\xE9ation pour l'\xE9v\xE9nement ${e}`);let t=await W(e);if(!t)return;let{eventData:n,user:r,contentHash:i}=t;console.log("[Appwrite Client] Donn\xE9es valid\xE9es, appel de la fonction");let l=await H(e,n,r.$id,i);console.log("[Appwrite Client] Op\xE9ration r\xE9ussie, redirection vers la liste"),window.location.href=`/sv_products/?listId=${e}`}catch(t){throw console.error("[Appwrite Client] Erreur lors de la cr\xE9ation:",t.message),t.message.includes("already_exists")?new Error("Cette liste de produits existe d\xE9j\xE0. Veuillez r\xE9essayer avec un ID diff\xE9rent."):t.message.includes("transaction_limit_exceeded")?new Error("Limite de transactions d\xE9pass\xE9e. Veuillez r\xE9duire le nombre d'ingr\xE9dients ou r\xE9essayer plus tard."):t}}async function Q(e){try{let{databases:t}=await u();return!!await t.getDocument("689d15b10003a5a13636","main",e)}catch(t){return t.code===404||console.error("[Appwrite Client] Erreur lors de la v\xE9rification du main group existant:",t),!1}}async function Y(){try{R(),await(await d()).deleteSession("current")}catch(e){console.warn("[Appwrite Client] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}}function X(e,t,n){localStorage.setItem("appwrite-user-email",e),localStorage.setItem("appwrite-user-name",t),localStorage.setItem("sveltia-cms.user",JSON.stringify(n))}function Z(e,t,n,r={}){let{onConnect:i,onDisconnect:l,onError:a}=r;if(!s)return console.error("Impossible de s'abonner : le client Appwrite n'est pas encore initialis\xE9."),a?.({message:"Client Appwrite non initialis\xE9"}),()=>{};let f=e.map(A=>{let h=c.collections[A];return h?`databases.${c.databaseId}.collections.${h}.documents`:(console.warn(`[Appwrite Client] Nom de collection inconnu dans la configuration: ${A}`),null)}).filter(Boolean);console.log("[Appwrite Client] Abonnement aux canaux en cours...",f);try{let A=s.subscribe(f,h=>{console.log("[Appwrite Client] R\xE9ception temps r\xE9el:",h),n(h)});return i&&setTimeout(()=>{console.log("[Appwrite Client] Connexion temps r\xE9el \xE9tablie"),i()},50),A}catch(A){return console.error("[Appwrite Client] Erreur lors de la souscription temps r\xE9el:",A),a?.(A),()=>{}}}typeof window<"u"&&(window.AppwriteClient={getAppwriteClients:N,getAccount:d,getFunctions:O,getDatabases:V,getConfig:D,isInitialized:q,initializeAppwrite:u,getLocalCmsUser:$,isAuthenticatedCms:L,isAuthenticatedAppwrite:j,isConnectedAppwrite:M,getUserEmail:F,getUserName:G,clearAuthData:R,setAuthData:X,logoutGlobal:Y,isEmailVerified:k,sendVerificationEmail:z,verifyEmail:B,getLocalEmailVerificationStatus:J,createCollaborativeProductsListFromEvent:K,checkExistingMainGroup:Q,subscribeToCollections:Z});var{APPWRITE_ENDPOINT:ee,APPWRITE_PROJECT_ID:te}=D(),S="689bf6fe0006627d8959",C="invitation_sent_emails",ne=!1;function ie(){localStorage.removeItem(C)}function re(e){return JSON.parse(localStorage.getItem(C)||"[]").includes(e)}function U(e){let t=JSON.parse(localStorage.getItem(C)||"[]");t.includes(e)||(t.push(e),localStorage.setItem(C,JSON.stringify(t)),void 0)}var m,I,o,b;function ae(){if(m=document.getElementById("status-container"),I=document.getElementById("status-message"),o=document.getElementById("status-details"),b=document.getElementById("login-button"),!m||!I||!o)throw new Error("Certains \xE9l\xE9ments DOM requis sont manquants")}function p(e,t){`${e}`,m&&(m.style.display="none"),o&&(o.className=`alert alert-${e} my-2`,o.textContent=t,o.style.display="block")}function T(e){I&&(I.textContent=e)}async function oe(){let e=null;try{window.location.href,window.location.search,ae(),T("Initialisation du client Appwrite...");let t=await d(),n=await _();let r=new URLSearchParams(window.location.search);if(e=r.get("requester"),Object.fromEntries(r.entries()),!e){p("danger","Email du demandeur manquant dans l'URL. Le lien est peut-\xEAtre corrompu.");return}T("V\xE9rification de votre authentification...");let i=await t.get();if(i.name,i.email,i.$id,T(`Connect\xE9 en tant que ${i.name}. Envoi de l'invitation \xE0 ${e}...`),re(e)){if(p("warning",`Une invitation a d\xE9j\xE0 \xE9t\xE9 envoy\xE9e \xE0 ${e}. Veuillez patienter qu'elle soit accept\xE9e.`),o){let a=document.createElement("button");a.className="btn btn-warning btn-sm ms-2",a.textContent="R\xE9essayer",a.onclick=()=>{ie(),window.location.reload()},o.appendChild(a)}return}`${window.location.origin}`;let l=await n.createMembership(S,["owner"],e,void 0,void 0,`${window.location.origin}/accept-invitation`);U(e),l.$id,p("success",`Invitation envoy\xE9e avec succ\xE8s \xE0 ${e} !`)}catch(t){console.error("Erreur lors du traitement de l'invitation :",t),t.code,t.message,t.type,t.response,t.stack,ne&&console.error("D\xE9tails complets de l'erreur:",t),t.code===401||t.message?.includes("not authenticated")||t.message?.includes("Unauthorized")?(p("danger","Vous devez \xEAtre connect\xE9 en tant qu'administrateur pour approuver une invitation."),b&&(b.style.display="inline-block")):t.code===409?(p("warning",`${e||"cet utilisateur"} est d\xE9j\xE0 membre de l'\xE9quipe ou a d\xE9j\xE0 une invitation en attente.`),e&&U(e)):t.code===400?p("danger",`Requ\xEAte invalide : ${t.message||"V\xE9rifiez les param\xE8tres de l'invitation"}`):t.message?.includes("Appwrite")||t.message?.includes("SDK")?p("danger",t.message):p("danger",`Une erreur inattendue est survenue : ${t.message||"Erreur inconnue"}`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{x()}):x();function x(){oe().catch(e=>{console.error("Erreur non captur\xE9e dans handleInvitation:",e),o&&(o.className="alert alert-danger  my-2",o.textContent="Une erreur critique est survenue. Veuillez consulter la console pour plus de d\xE9tails.",o.style.display="block"),m&&(m.style.display="none")})}setTimeout(()=>{m&&m.style.display!=="none"&&p("danger","Le traitement prend trop de temps. Veuillez v\xE9rifier votre connexion et r\xE9essayer.")},3e4);})();
