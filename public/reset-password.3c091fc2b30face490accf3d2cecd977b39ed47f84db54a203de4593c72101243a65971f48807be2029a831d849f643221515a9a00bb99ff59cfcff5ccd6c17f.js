(()=>{var u={endpoint:"https://cloud.appwrite.io/v1",projectId:"689725820024e81781b7",databaseId:"689d15b10003a5a13636",functions:{cmsAuth:"68976500002eb5c6ee4f",accessRequest:"689cdea5001a4d74549d",batchUpdate:"68f00487000c624533a3"},collections:{main:"main",purchases:"purchases",products:"products"}},l=null,w=null,f=null,g=null,E=null,h=null;function x(e=50,t=100){return new Promise((n,r)=>{let i=0;function s(){i++,window.Appwrite&&window.Appwrite.Client&&window.Appwrite.Account?n():i>=e?(console.error("[Appwrite Client] SDK Appwrite non charg\xE9 apr\xE8s le nombre maximum de tentatives"),r(new Error("Le SDK Appwrite n'a pas pu \xEAtre charg\xE9."))):setTimeout(s,t)}s()})}async function y(){return l&&w&&f&&g?{client:l,account:w,functions:f,databases:g}:h||(h=(async()=>{try{console.log("[Appwrite Client] D\xE9but de l'initialisation"),await x();let{Client:e,Account:t,Functions:n,Databases:r,Teams:i}=window.Appwrite;return l=new e().setEndpoint(u.endpoint).setProject(u.projectId),w=new t(l),f=new n(l),g=new r(l),E=new i(l),console.log("[Appwrite Client] Initialisation termin\xE9e avec succ\xE8s"),{client:l,account:w,functions:f,databases:g,teams:E}}catch(e){throw console.error("[Appwrite Client] Erreur lors de l'initialisation:",e),l=null,w=null,f=null,g=null,E=null,h=null,e}})(),h)}async function L(){return await y()}async function p(){return w||await y(),w}async function _(){return f||await y(),f}async function T(){return g||await y(),g}function $(){return{APPWRITE_ENDPOINT:u.endpoint,APPWRITE_PROJECT_ID:u.projectId,APPWRITE_FUNCTION_ID:u.functions.cmsAuth,ACCESS_REQUEST_FUNCTION_ID:u.functions.accessRequest,APPWRITE_CONFIG:u}}function U(){return!!(l&&w&&f&&g&&E)}function P(){let e=localStorage.getItem("sveltia-cms.user");if(!e)return null;try{let t=JSON.parse(e);return t.token&&typeof t.token=="string"&&t.token.trim()!==""?t:(localStorage.removeItem("sveltia-cms.user"),null)}catch{return localStorage.removeItem("sveltia-cms.user"),null}}function N(){return P()!==null}async function R(){try{return await(await p()).get(),!0}catch{return!1}}async function V(){try{let e=await p(),t=await e.get();if(!t||!t.$id)return!1;let n=await e.getSession("current");if(!n||!n.$id)return!1;let r=new Date,i=new Date(n.expire);return!(r>=i)}catch(e){return console.error("Error checking connection:",e),!1}}async function O(){try{return(await(await p()).get()).emailVerification||!1}catch{return!1}}async function k(e=null){try{let t=await p(),n=e||`${window.location.origin}/verify-email`;await t.createVerification(n)}catch(t){throw console.error("[AppwriteClient] Erreur lors de l'envoi de l'email de v\xE9rification:",t),t}}async function F(e,t){try{await(await p()).updateVerification(e,t)}catch(n){throw console.error("[AppwriteClient] Erreur lors de la v\xE9rification d'email:",n),n}}function B(){return localStorage.getItem("appwrite-user-email")}function j(){return localStorage.getItem("appwrite-user-name")}function M(){return localStorage.getItem("email-verification-status")}function S(){localStorage.removeItem("sveltia-cms.user"),localStorage.removeItem("appwrite-user-email"),localStorage.removeItem("appwrite-user-name"),localStorage.removeItem("email-verification-status")}async function G(e){console.log(`[Appwrite Client] Validation des donn\xE9es pour l'\xE9v\xE9nement ${e}`);let t=await fetch(`/evenements/${e}/ingredients_aw/index.json`);if(!t.ok)throw new Error(`Impossible de r\xE9cup\xE9rer les donn\xE9es de l'\xE9v\xE9nement: ${t.status}`);let n=await t.json();console.log("[Appwrite Client] Donn\xE9es de l'\xE9v\xE9nement r\xE9cup\xE9r\xE9es:",n);let{account:r,databases:i}=await y(),s=await r.get();console.log(`[Appwrite Client] Utilisateur authentifi\xE9: ${s.$id}`);try{return await i.getDocument(u.databaseId,u.collections.main,e),console.log(`[Appwrite Client] L'\xE9v\xE9nement ${e} existe d\xE9j\xE0 dans main`),window.location.href=`/sv_products/?listId=${e}`,null}catch(a){if(a.code!==404)throw a}let o=window.__HUGO_PARAMS__?.listContentHash;if(!o)throw new Error("Le hash du contenu n'est pas d\xE9fini");return{eventData:n,user:s,contentHash:o}}async function z(e,t,n,r){console.log(`[Appwrite Client] Appel de la fonction serveur pour ${e}`);let i=u.functions.createProductList,{functions:s}=await y();try{let o=await s.createExecution(i,JSON.stringify({eventId:e,eventData:t,userId:n,contentHash:r}),!0,"/","GET",{});console.log("[Appwrite Client] Ex\xE9cution d\xE9marr\xE9e en mode asynchrone:",o);let a=o.$id;return console.log(`[Appwrite Client] Execution ID: ${a}`),console.log("[Appwrite Client] Ex\xE9cution async d\xE9marr\xE9e pour 300+ ingr\xE9dients - pas de polling"),{success:!0,eventId:e,executionId:a,message:"Traitement d\xE9marr\xE9 en arri\xE8re-plan (300+ ingr\xE9dients)",isAsync:!0}}catch(o){throw console.error("[Appwrite Client] Erreur lors de l'appel fonction:",o),o}}async function q(e){try{console.log(`[Appwrite Client] D\xE9but de la cr\xE9ation pour l'\xE9v\xE9nement ${e}`);let t=await G(e);if(!t)return;let{eventData:n,user:r,contentHash:i}=t;console.log("[Appwrite Client] Donn\xE9es valid\xE9es, appel de la fonction");let s=await z(e,n,r.$id,i);console.log("[Appwrite Client] Op\xE9ration r\xE9ussie, redirection vers la liste"),window.location.href=`/sv_products/?listId=${e}`}catch(t){throw console.error("[Appwrite Client] Erreur lors de la cr\xE9ation:",t.message),t.message.includes("already_exists")?new Error("Cette liste de produits existe d\xE9j\xE0. Veuillez r\xE9essayer avec un ID diff\xE9rent."):t.message.includes("transaction_limit_exceeded")?new Error("Limite de transactions d\xE9pass\xE9e. Veuillez r\xE9duire le nombre d'ingr\xE9dients ou r\xE9essayer plus tard."):t}}async function W(e){try{let{databases:t}=await y();return!!await t.getDocument("689d15b10003a5a13636","main",e)}catch(t){return t.code===404||console.error("[Appwrite Client] Erreur lors de la v\xE9rification du main group existant:",t),!1}}async function H(){try{S(),await(await p()).deleteSession("current")}catch(e){console.warn("[Appwrite Client] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}}function J(e,t,n){localStorage.setItem("appwrite-user-email",e),localStorage.setItem("appwrite-user-name",t),localStorage.setItem("sveltia-cms.user",JSON.stringify(n))}function K(e,t,n,r={}){let{onConnect:i,onDisconnect:s,onError:o}=r;if(!l)return console.error("Impossible de s'abonner : le client Appwrite n'est pas encore initialis\xE9."),o?.({message:"Client Appwrite non initialis\xE9"}),()=>{};let a=e.map(c=>{let m=u.collections[c];return m?`databases.${u.databaseId}.collections.${m}.documents`:(console.warn(`[Appwrite Client] Nom de collection inconnu dans la configuration: ${c}`),null)}).filter(Boolean);console.log("[Appwrite Client] Abonnement aux canaux en cours...",a);try{let c=l.subscribe(a,m=>{console.log("[Appwrite Client] R\xE9ception temps r\xE9el:",m),n(m)});return i&&setTimeout(()=>{console.log("[Appwrite Client] Connexion temps r\xE9el \xE9tablie"),i()},50),c}catch(c){return console.error("[Appwrite Client] Erreur lors de la souscription temps r\xE9el:",c),o?.(c),()=>{}}}typeof window<"u"&&(window.AppwriteClient={getAppwriteClients:L,getAccount:p,getFunctions:_,getDatabases:T,getConfig:$,isInitialized:U,initializeAppwrite:y,getLocalCmsUser:P,isAuthenticatedCms:N,isAuthenticatedAppwrite:R,isConnectedAppwrite:V,getUserEmail:B,getUserName:j,clearAuthData:S,setAuthData:J,logoutGlobal:H,isEmailVerified:O,sendVerificationEmail:k,verifyEmail:F,getLocalEmailVerificationStatus:M,createCollaborativeProductsListFromEvent:q,checkExistingMainGroup:W,subscribeToCollections:K});document.addEventListener("DOMContentLoaded",async()=>{let e=document.getElementById("reset-password-form"),t=document.getElementById("new-password"),n=document.getElementById("confirm-password"),r=document.getElementById("reset-password-button"),i=r?r.querySelector(".spinner-border"):null,s=document.getElementById("reset-password-message"),o=document.getElementById("password-match-error"),a=document.getElementById("success-message");function c(C,A){s&&(s.textContent=A,s.className=`alert alert-${C} my-4 rounded`,s.style.display="block")}s&&(s.style.display="none"),o&&(o.style.display="none"),e&&(e.style.display="none"),a&&(a.style.display="none");let m=new URLSearchParams(window.location.search),I=m.get("userId"),b=m.get("secret");if(!I||!b){c("danger","Lien de r\xE9initialisation de mot de passe invalide ou expir\xE9.");return}e&&(e.style.display="block"),e.addEventListener("submit",async C=>{C.preventDefault();let A=t?t.value:"",D=n?n.value:"";if(s&&(s.style.display="none"),o&&(o.style.display="none"),A!==D){o&&(o.style.display="block"),t.classList.add("is-invalid"),n.classList.add("is-invalid");return}else t.classList.remove("is-invalid"),n.classList.remove("is-invalid");if(A.length<8){c("danger","Le nouveau mot de passe doit contenir au moins 8 caract\xE8res."),t.classList.add("is-invalid");return}else t.classList.remove("is-invalid");r&&(r.disabled=!0),i&&(i.style.display="inline-block");try{await(await p()).updateRecovery(I,b,A,D),e&&(e.style.display="none"),a&&(a.style.display="block"),c("success","Votre mot de passe a \xE9t\xE9 r\xE9initialis\xE9 avec succ\xE8s !"),setTimeout(()=>{window.location.href="/login"},5e3)}catch(d){console.error("[ResetPassword] Erreur lors de la r\xE9initialisation du mot de passe:",d);let v="Une erreur est survenue lors de la r\xE9initialisation de votre mot de passe. Veuillez r\xE9essayer ou contacter l'administrateur.";d.response&&d.response.message?d.response.code===401&&d.response.message.includes("Invalid secret")?v="Le lien de r\xE9initialisation est invalide ou a expir\xE9. Veuillez refaire une demande.":v=d.response.message:d.message&&(v=d.message),c("danger",v)}finally{r&&(r.disabled=!1),i&&(i.style.display="none")}})});})();
