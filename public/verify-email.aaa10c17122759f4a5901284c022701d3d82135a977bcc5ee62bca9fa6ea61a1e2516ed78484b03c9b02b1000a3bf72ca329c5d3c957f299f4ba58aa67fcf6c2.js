(()=>{var ne=Object.defineProperty;var re=(e,t)=>()=>(e&&(t=e(e=0)),t);var ie=(e,t)=>{for(var n in t)ne(e,n,{get:t[n],enumerable:!0})};var U={};ie(U,{APPWRITE_CONFIG:()=>c,checkExistingMainGroup:()=>K,clearAuthData:()=>$,createCollaborativeProductsListFromEvent:()=>H,getAccount:()=>m,getAppwriteClients:()=>N,getConfig:()=>R,getDatabases:()=>O,getFunctions:()=>k,getLocalCmsUser:()=>T,getLocalEmailVerificationStatus:()=>W,getTeams:()=>ae,getUserEmail:()=>z,getUserName:()=>J,initializeAppwrite:()=>p,isAuthenticatedAppwrite:()=>F,isAuthenticatedCms:()=>B,isConnectedAppwrite:()=>j,isEmailVerified:()=>q,isInitialized:()=>M,logoutGlobal:()=>Q,sendVerificationEmail:()=>G,setAuthData:()=>D,subscribeToCollections:()=>X,verifyEmail:()=>x});function oe(e=50,t=100){return new Promise((n,i)=>{let r=0;function a(){r++,window.Appwrite&&window.Appwrite.Client&&window.Appwrite.Account?n():r>=e?(console.error("[Appwrite Client] SDK Appwrite non charg\xE9 apr\xE8s le nombre maximum de tentatives"),i(new Error("Le SDK Appwrite n'a pas pu \xEAtre charg\xE9."))):setTimeout(a,t)}a()})}async function p(){return u&&w&&g&&y?{client:u,account:w,functions:g,databases:y}:I||(I=(async()=>{try{console.log("[Appwrite Client] D\xE9but de l'initialisation"),await oe();let{Client:e,Account:t,Functions:n,Databases:i,Teams:r}=window.Appwrite;return u=new e().setEndpoint(c.endpoint).setProject(c.projectId),w=new t(u),g=new n(u),y=new i(u),A=new r(u),console.log("[Appwrite Client] Initialisation termin\xE9e avec succ\xE8s"),{client:u,account:w,functions:g,databases:y,teams:A}}catch(e){throw console.error("[Appwrite Client] Erreur lors de l'initialisation:",e),u=null,w=null,g=null,y=null,A=null,I=null,e}})(),I)}async function N(){return await p()}async function m(){return w||await p(),w}async function ae(){return A||await p(),A}async function k(){return g||await p(),g}async function O(){return y||await p(),y}function R(){return{APPWRITE_ENDPOINT:c.endpoint,APPWRITE_PROJECT_ID:c.projectId,APPWRITE_FUNCTION_ID:c.functions.cmsAuth,ACCESS_REQUEST_FUNCTION_ID:c.functions.accessRequest,APPWRITE_CONFIG:c}}function M(){return!!(u&&w&&g&&y&&A)}function T(){let e=localStorage.getItem("sveltia-cms.user");if(!e)return null;try{let t=JSON.parse(e);return t.token&&typeof t.token=="string"&&t.token.trim()!==""?t:(localStorage.removeItem("sveltia-cms.user"),null)}catch{return localStorage.removeItem("sveltia-cms.user"),null}}function B(){return T()!==null}async function F(){try{return await(await m()).get(),!0}catch{return!1}}async function j(){try{let e=await m(),t=await e.get();if(!t||!t.$id)return!1;let n=await e.getSession("current");if(!n||!n.$id)return!1;let i=new Date,r=new Date(n.expire);return!(i>=r)}catch(e){return console.error("Error checking connection:",e),!1}}async function q(){try{return(await(await m()).get()).emailVerification||!1}catch{return!1}}async function G(e=null){try{let t=await m(),n=e||`${window.location.origin}/verify-email`;await t.createVerification(n)}catch(t){throw console.error("[AppwriteClient] Erreur lors de l'envoi de l'email de v\xE9rification:",t),t}}async function x(e,t){try{await(await m()).updateVerification(e,t)}catch(n){throw console.error("[AppwriteClient] Erreur lors de la v\xE9rification d'email:",n),n}}function z(){return localStorage.getItem("appwrite-user-email")}function J(){return localStorage.getItem("appwrite-user-name")}function W(){return localStorage.getItem("email-verification-status")}function $(){localStorage.removeItem("sveltia-cms.user"),localStorage.removeItem("appwrite-user-email"),localStorage.removeItem("appwrite-user-name"),localStorage.removeItem("email-verification-status")}async function se(e){console.log(`[Appwrite Client] Validation des donn\xE9es pour l'\xE9v\xE9nement ${e}`);let t=await fetch(`/evenements/${e}/ingredients_aw/index.json`);if(!t.ok)throw new Error(`Impossible de r\xE9cup\xE9rer les donn\xE9es de l'\xE9v\xE9nement: ${t.status}`);let n=await t.json();console.log("[Appwrite Client] Donn\xE9es de l'\xE9v\xE9nement r\xE9cup\xE9r\xE9es:",n);let{account:i,databases:r}=await p(),a=await i.get();console.log(`[Appwrite Client] Utilisateur authentifi\xE9: ${a.$id}`);try{return await r.getDocument(c.databaseId,c.collections.main,e),console.log(`[Appwrite Client] L'\xE9v\xE9nement ${e} existe d\xE9j\xE0 dans main`),window.location.href=`/sv_products/?listId=${e}`,null}catch(d){if(d.code!==404)throw d}let o=window.__HUGO_PARAMS__?.listContentHash;if(!o)throw new Error("Le hash du contenu n'est pas d\xE9fini");return{eventData:n,user:a,contentHash:o}}async function ce(e,t,n,i){console.log(`[Appwrite Client] Appel de la fonction serveur pour ${e}`);let r=c.functions.createProductList,{functions:a}=await p();try{let o=await a.createExecution(r,JSON.stringify({eventId:e,eventData:t,userId:n,contentHash:i}),!0,"/","GET",{});console.log("[Appwrite Client] Ex\xE9cution d\xE9marr\xE9e en mode asynchrone:",o);let d=o.$id;return console.log(`[Appwrite Client] Execution ID: ${d}`),console.log("[Appwrite Client] Ex\xE9cution async d\xE9marr\xE9e pour 300+ ingr\xE9dients - pas de polling"),{success:!0,eventId:e,executionId:d,message:"Traitement d\xE9marr\xE9 en arri\xE8re-plan (300+ ingr\xE9dients)",isAsync:!0}}catch(o){throw console.error("[Appwrite Client] Erreur lors de l'appel fonction:",o),o}}async function H(e){try{console.log(`[Appwrite Client] D\xE9but de la cr\xE9ation pour l'\xE9v\xE9nement ${e}`);let t=await se(e);if(!t)return;let{eventData:n,user:i,contentHash:r}=t;console.log("[Appwrite Client] Donn\xE9es valid\xE9es, appel de la fonction");let a=await ce(e,n,i.$id,r);console.log("[Appwrite Client] Op\xE9ration r\xE9ussie, redirection vers la liste"),window.location.href=`/sv_products/?listId=${e}`}catch(t){throw console.error("[Appwrite Client] Erreur lors de la cr\xE9ation:",t.message),t.message.includes("already_exists")?new Error("Cette liste de produits existe d\xE9j\xE0. Veuillez r\xE9essayer avec un ID diff\xE9rent."):t.message.includes("transaction_limit_exceeded")?new Error("Limite de transactions d\xE9pass\xE9e. Veuillez r\xE9duire le nombre d'ingr\xE9dients ou r\xE9essayer plus tard."):t}}async function K(e){try{let{databases:t}=await p();return!!await t.getDocument("689d15b10003a5a13636","main",e)}catch(t){return t.code===404||console.error("[Appwrite Client] Erreur lors de la v\xE9rification du main group existant:",t),!1}}async function Q(){try{$(),await(await m()).deleteSession("current")}catch(e){console.warn("[Appwrite Client] Erreur lors de la d\xE9connexion Appwrite (peut-\xEAtre d\xE9j\xE0 d\xE9connect\xE9):",e)}}function D(e,t,n){localStorage.setItem("appwrite-user-email",e),localStorage.setItem("appwrite-user-name",t),localStorage.setItem("sveltia-cms.user",JSON.stringify(n))}function X(e,t,n,i={}){let{onConnect:r,onDisconnect:a,onError:o}=i;if(!u)return console.error("Impossible de s'abonner : le client Appwrite n'est pas encore initialis\xE9."),o?.({message:"Client Appwrite non initialis\xE9"}),()=>{};let d=e.map(l=>{let f=c.collections[l];return f?`databases.${c.databaseId}.collections.${f}.documents`:(console.warn(`[Appwrite Client] Nom de collection inconnu dans la configuration: ${l}`),null)}).filter(Boolean);console.log("[Appwrite Client] Abonnement aux canaux en cours...",d);try{let l=u.subscribe(d,f=>{console.log("[Appwrite Client] R\xE9ception temps r\xE9el:",f),n(f)});return r&&setTimeout(()=>{console.log("[Appwrite Client] Connexion temps r\xE9el \xE9tablie"),r()},50),l}catch(l){return console.error("[Appwrite Client] Erreur lors de la souscription temps r\xE9el:",l),o?.(l),()=>{}}}var c,u,w,g,y,A,I,V=re(()=>{c={endpoint:"https://cloud.appwrite.io/v1",projectId:"689725820024e81781b7",databaseId:"689d15b10003a5a13636",functions:{cmsAuth:"68976500002eb5c6ee4f",accessRequest:"689cdea5001a4d74549d",batchUpdate:"68f00487000c624533a3"},collections:{main:"main",purchases:"purchases",products:"products"}},u=null,w=null,g=null,y=null,A=null,I=null;typeof window<"u"&&(window.AppwriteClient={getAppwriteClients:N,getAccount:m,getFunctions:k,getDatabases:O,getConfig:R,isInitialized:M,initializeAppwrite:p,getLocalCmsUser:T,isAuthenticatedCms:B,isAuthenticatedAppwrite:F,isConnectedAppwrite:j,getUserEmail:z,getUserName:J,clearAuthData:$,setAuthData:D,logoutGlobal:Q,isEmailVerified:q,sendVerificationEmail:G,verifyEmail:x,getLocalEmailVerificationStatus:W,createCollaborativeProductsListFromEvent:H,checkExistingMainGroup:K,subscribeToCollections:X})});V();document.addEventListener("DOMContentLoaded",async()=>{let e=document.getElementById("loading-state"),t=document.getElementById("success-state"),n=document.getElementById("error-state"),i=document.getElementById("expired-state"),r=document.getElementById("error-message"),a=document.getElementById("retry-button"),o=a?.querySelector(".spinner-border"),d=document.getElementById("config-state"),l=document.getElementById("edit-button"),f=new URLSearchParams(window.location.search),v=f.get("userId"),_=f.get("secret");function E(s){e&&(e.style.display=s==="loading"?"block":"none"),t&&(t.style.display=s==="success"?"block":"none"),n&&(n.style.display=s==="error"?"block":"none"),i&&(i.style.display=s==="expired"?"block":"none"),d&&(d.style.display=s==="config"?"block":"none")}async function Y(){let{APPWRITE_FUNCTION_ID:s}=await Promise.resolve().then(()=>(V(),U)).then(h=>h.getConfig());try{let S=await(await m()).get();if(!S.emailVerification)throw new Error("EMAIL_NOT_VERIFIED");let{getFunctions:Z}=await Promise.resolve().then(()=>(V(),U)),ee=await Z();console.log("[Verify Email] Appel de la fonction CMS...");let P=await ee.createExecution(s,JSON.stringify({action:"get-cms-token",userId:S.$id}),!1);console.log("[Verify Email] R\xE9ponse de la fonction CMS:",P.responseBody);let b;try{b=JSON.parse(P.responseBody)}catch(te){throw console.error("[Verify Email] Erreur de parsing de la r\xE9ponse CMS:",te),new Error(`Erreur de parsing: ${P.responseBody}`)}if(!b.success)throw new Error(`Erreur de la fonction CMS: ${b.error||"Erreur inconnue"}`);let C=b.user;if(!C||!C.token||typeof C.token!="string"||C.token.trim()==="")throw new Error("Token CMS invalide re\xE7u de la fonction");return D(S.email,S.name,C),console.log("[Verify Email] Configuration CMS termin\xE9e avec succ\xE8s"),!0}catch(h){throw console.error("[Verify Email] Erreur lors de la configuration CMS:",h),h}}async function L(){try{console.log("[Verify Email] Tentative de v\xE9rification avec userId:",v),await x(v,_),localStorage.removeItem("email-verification-status"),console.log("[Verify Email] V\xE9rification r\xE9ussie"),E("config");try{await Y(),console.log("[Verify Email] Configuration compl\xE8te termin\xE9e"),E("success"),l&&(l.disabled=!1,l.classList.remove("btn-secondary"),l.classList.add("btn-primary"))}catch(s){console.error("[Verify Email] Erreur lors de la configuration CMS:",s),r&&(r.textContent="Email v\xE9rifi\xE9 mais erreur lors de la configuration du compte. Veuillez vous reconnecter."),E("error")}}catch(s){console.error("[Verify Email] Erreur lors de la v\xE9rification:",s),s.code===401||s.message?.includes("invalid")||s.message?.includes("expired")?E("expired"):(r&&(r.textContent=s.message||"Une erreur inattendue est survenue lors de la v\xE9rification."),E("error"))}}if(a&&a.addEventListener("click",async()=>{a.disabled=!0,o&&(o.style.display="inline-block"),E("loading"),await L(),a.disabled=!1,o&&(o.style.display="none")}),!v||!_){console.warn("[Verify Email] Param\xE8tres manquants - userId:",!!v,"secret:",!!_),r&&(r.textContent="Lien de v\xE9rification invalide. Les param\xE8tres requis sont manquants."),E("error");return}setTimeout(async()=>{await L()},500)});})();
