import{B as oe,d as ke,m as e,u as b,O as m,G as k,z as Se,J as S,y as _,I as d,N as W,A as i,Y as Ee,v as A,k as re,K as E,h as p,g as l,P as Le,b as y,c as Be,w as te,x as ae,F as $e,av as De,aw as Ve,az as ze,ay as qe,j as Ce,C as se,o as v}from"./appwrite-_5e16uFI.js";import{r as O}from"./RecipeDataStore.svelte-GOXcMiWH.js";import{n as ie,a as He}from"./index-DPkaPVhg.js";import{t as Te,a as K,v as Me,e as Ue,n as We,p as Fe,f as Pe,R as je,b as Ge,d as Oe}from"./RecipeEditPage-C5oXcqlr.js";import"./AutocompleteInput-BBC9wzun.js";import{C as Ke}from"./ConfirmModal-zApyBwKm.js";import{U as Je}from"./UnsavedChangesGuard-B7og0wIL.js";import{R as Ne,a as Ye}from"./RecipeMetadata-DnorRj1I.js";import{z as Ze,_ as Qe,b as Xe,aj as er}from"./icons-BII4FnZr.js";import"./products-display-C75vxtDO.js";import"./tiptap-markdown.es-CRpBaFG9.js";import"./Fieldset-CLHit-xl.js";import"./BtnGroupCheck-Dh8oiY9f.js";import"./CheckboxBadge-DYaE4jj7.js";import"./keyboardNavigation.svelte-ETytoTUJ.js";oe(["click"]);var rr=A('<div class="flex items-center gap-2"><button class="btn btn-secondary btn-soft btn-sm"><!> Cr√©er une version alternative</button> <button class="btn btn-accent btn-sm"><!> </button></div>'),tr=A('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),ar=A('<div class="mt-8 print:hidden"><!></div>'),sr=A(`<div class="alert alert-error alert-soft border-error max-md:alert-vertical mt-8 border"><!> <div class="flex-1"><h4 class="font-bold">Zone de danger</h4> <p class="text-sm">La suppression d'une recette est irr√©versible. Si elle √©tait
              utilis√© dans des √©v√©nements, ceux-ci n'y auront plus acc√®s. Vous
              √™tes seul¬∑e autoris√© √† supprimer une recettes que vous avez cr√©e.
              Les versions alternatives cr√©es √† partir de celle-ci ne seront pas
              supprim√©e.</p></div> <button class="btn btn-error btn-sm"> </button></div>`),ir=A('<div class="space-y-6"><!> <!> <!> <!> <!> <!></div>'),or=A(`<div class="bg-base-100 rounded-t-box fixed bottom-0 left-0"><div class=" bg-warning/40 rounded-t-box flex size-full items-center px-4 py-1"><!> V√©rouill√© : document en cours d'√©dition par un¬∑e autre utilisateur¬∑ice.</div></div>`),nr=A('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!> <!> <!>',1);function xr(ne,ce){ke(ce,!0);const ue=t=>{var a=rr(),o=p(a);o.__click=ve;var g=p(o);Ze(g,{class:"h-4 w-4"}),se(),v(o);var c=l(o,2);c.__click=J;var u=p(c);Qe(u,{class:"h-4 w-4"});var R=l(u);v(c),v(a),te(()=>{o.disabled=!e(I)||e(h),c.disabled=!e(I)||e(h)||!e(z),ae(R,` ${e(h)?"Sauvegarde...":"Sauvegarder"}`)}),y(t,a)},s=b(()=>$e.params.uuid);if(!e(s))throw m.error("ID de recette manquant"),k("/recipe"),new Error("recipeId is required");let r=_(null),L=_(!1),x=_(!0),h=_(!1),w=_(null),$=null,B=_(null),D=_(!1),V=_(!1),F=Se({value:{}});const z=b(()=>!e(r)||!e(B)?!1:K(e(r))!==e(B));S(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const P=b(()=>!!e(w)&&e(w)!==d.userId),q=b(()=>!!e(w)&&e(w)===d.userId),I=b(()=>!e(P)&&!e(x)),de=b(()=>({materiel:O.materiel,categories:O.categories,regimes:O.regimes}));S(()=>{if(!d.userId){m.error("Vous devez √™tre connect√©"),k("/");return}}),S(()=>{e(s)&&!e(L)&&!e(x)||e(s)&&e(L)||e(s)&&!e(L)&&e(x)&&W.getRecipeByUuid(e(s)).then(async t=>{t?(i(r,Te(t,{$createdAt:t.$createdAt,$updatedAt:t.$updatedAt,createdBy:t.createdBy}),!0),i(w,t.lockedBy||null,!0),i(L,!0),i(x,!1),await pe()):(m.error("Recette introuvable"),k("/recipe"))}).catch(t=>{console.error("Erreur chargement:",t),m.error("Erreur lors du chargement"),k("/recipe")}).finally(()=>{i(x,!1)})}),S(()=>{e(r)&&e(L)&&!e(B)&&i(B,K(e(r)),!0)}),S(()=>{ie.setConfig({title:e(r)?.title||"√âdition de recette",actions:ue})}),Ee(async()=>{ie.reset(),G(),e(q)&&!e(h)&&await C(),window.removeEventListener("beforeunload",j)});function j(t){e(z)&&(t.preventDefault(),t.returnValue="")}S(()=>{e(z)?window.addEventListener("beforeunload",j):window.removeEventListener("beforeunload",j)});function le(){G(),!(!e(s)||!e(q))&&($=setInterval(async()=>{try{console.log("üíì Heartbeat: Refreshing lock..."),await W.updateRecipeLock(e(s),d.userId)}catch(t){console.error("‚ùå Heartbeat failed:",t)}},12e4))}function G(){$&&(clearInterval($),$=null)}async function pe(){if(!e(s)||!d.userId||!e(r))return!1;if((e(r).permissionWrite||[]).length<=1)return console.log("‚ÑπÔ∏è Verrou ignor√© (contributeur unique)"),!0;try{const a=e(r).lockedBy,o=e(r).$updatedAt?new Date(e(r).$updatedAt):null,g=o&&Date.now()-o.getTime()>3e5;if(a&&a!==d.userId)if(g)console.log("‚è≥ Verrou pr√©c√©dent expir√©, reprise de contr√¥le...");else return!1;return await W.updateRecipeLock(e(s),d.userId),i(w,d.userId,!0),console.log("üîí Verrou acquis"),le(),!0}catch(a){return console.error("‚ùå Erreur acquisition verrou:",a),m.error("Impossible de verrouiller la recette"),!1}}async function C(){if(e(s)){G();try{await W.updateRecipeLock(e(s),null),i(w,null),console.log("üîì Verrou lib√©r√©")}catch(t){console.error("‚ùå Erreur lib√©ration verrou:",t)}}}async function J(){if(!e(r)||e(h)||!d.userId||!Me(e(r),F))return;i(h,!0);const a=m.loading("Sauvegarde en cours...");try{const{regimes:o}=Ue(e(r).ingredients),c={...We(e(r)),categories:e(r).categories,regime:o,saison:e(r).saison,ingredients:Ve(e(r).ingredients),quantite_desc:e(r).quantite_desc,auteur:e(r).auteur,preparation24h:e(r).preparation24h,astuces:De(e(r).astuces),prepAlt:e(r).prepAlt,$id:e(r).$id},u=await ze(e(s),c,d.userId);i(B,K(e(r)),!0);const R=Fe(e(r),c,{id:u.$id,createdAt:u.$createdAt,updatedAt:u.$updatedAt,createdBy:u.createdBy});qe("save_recipe",e(s),d.userId,R,!0).catch(T=>{console.error("Sync vers GitHub √©chou√©e:",T)}),m.update(a,{state:"success",message:"Recette sauvegard√©e !"}),await C()}catch(o){console.error("Erreur sauvegarde:",o),m.update(a,{state:"error",message:"Erreur lors de la sauvegarde"})}finally{i(h,!1),setTimeout(()=>m.dismiss(a),3e3)}}function ve(){e(r)&&k(`/recipe/${e(s)}/duplicate`)}function fe(){i(D,!0)}async function me(){if(e(s)){i(V,!0);try{await Pe(e(s),async()=>{e(q)&&await C()}),setTimeout(()=>{k("/recipe")},1500)}catch(t){console.error("Erreur lors de la suppression:",t)}finally{i(V,!1),i(D,!1)}}}var N=nr(),H=re(N),ge=p(H);{var be=t=>{var a=tr();y(t,a)},_e=t=>{var a=Ce(),o=re(a);{var g=c=>{var u=ir(),R=p(u);je(R,{get recipeInfo(){return e(de)},get validationErrors(){return F.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){i(r,n,!0)}});var T=l(R,2);Ge(T,{get validationErrors(){return F.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){i(r,n,!0)}});var Q=l(T,2);Oe(Q,{get createdBy(){return e(r).createdBy},get canEdit(){return e(I)},get permissionWrite(){return e(r).permissionWrite},set permissionWrite(n){e(r).permissionWrite=n}});var X=l(Q,2);{var we=n=>{{let f=b(()=>e(r).$id??"");Ne(n,{get auteur(){return e(r).auteur},get createdBy(){return e(r).createdBy},get id(){return e(f)},get createdAt(){return e(r).$createdAt},get updatedAt(){return e(r).$updatedAt}})}};E(X,n=>{e(r).$createdAt&&n(we)})}var ee=l(X,2);{var Ae=n=>{var f=ar(),M=p(f);Ye(M,{get recipeId(){return e(s)}}),v(f),y(n,f)};E(ee,n=>{e(s)&&n(Ae)})}var xe=l(ee,2);{var Ie=n=>{var f=sr(),M=p(f);er(M,{class:"h-5 w-5 shrink-0"});var U=l(M,4);U.__click=fe;var Re=p(U,!0);v(U),v(f),te(()=>{U.disabled=e(V),ae(Re,e(V)?"Suppression...":"Supprimer la recette")}),y(n,f)};E(xe,n=>{e(I)&&n(Ie)})}v(u),y(c,u)};E(o,c=>{e(r)&&c(g)},!0)}y(t,a)};E(ge,t=>{e(x)?t(be):t(_e,!1)})}v(H);var Y=l(H,2);{var ye=t=>{var a=or(),o=p(a),g=p(o);Xe(g,{class:"me-2 h-4 w-4"}),se(),v(o),v(a),y(t,a)};E(Y,t=>{e(P)&&t(ye)})}var Z=l(Y,2);{let t=b(()=>`/recipe/${e(s)}/edit`);Je(Z,{get routeKey(){return e(t)},shouldProtect:()=>e(z)&&!e(P),onLeaveWithoutSave:async()=>{e(q)&&await C()},onSaveAndLeave:async()=>{await J()},message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}var he=l(Z,2);Ke(he,{get isOpen(){return e(D)},title:"Supprimer cette recette ?",message:"Cette action est irr√©versible, √™tes vous sur de vouloir supprimer cette recette ?",variant:"danger",confirmLabel:"Supprimer",cancelLabel:"Annuler",onConfirm:me,onCancel:()=>i(D,!1)}),Le(3,H,()=>He),y(ne,N),Be()}oe(["click"]);export{xr as default};
